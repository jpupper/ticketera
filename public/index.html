<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ticketeadora térmica</title>
    <style>
      body { font-family: system-ui, Arial, sans-serif; background: #f7f7f7; margin: 0; }
      .container { max-width: 560px; margin: 40px auto; background: #fff; padding: 24px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
      h1 { margin-top: 0; font-size: 22px; }
      label { display: block; font-weight: 600; margin-top: 12px; }
      input[type="text"], textarea, input[type="file"], select { width: 100%; margin-top: 6px; padding: 10px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 6px; }
      textarea { min-height: 120px; resize: vertical; }
      .actions { margin-top: 18px; display: flex; gap: 12px; }
      button { cursor: pointer; padding: 10px 16px; border: none; border-radius: 6px; background: #0d6efd; color: white; font-weight: 600; }
      button:disabled { background: #9bb9ff; cursor: not-allowed; }
      .status { margin-top: 16px; min-height: 24px; }
      .preview { margin-top: 12px; }
      .preview img { max-width: 100%; border-radius: 6px; border: 1px solid #eee; }
      .ticket-preview { margin-top: 16px; border: 1px solid #ccc; border-radius: 6px; overflow: hidden; height: 420px; }
      .ticket-preview iframe { width: 100%; height: 100%; border: 0; }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Imprimir Ticket en Impresora Térmica</h1>

      <form id="ticketForm" enctype="multipart/form-data">
        <label for="title">Título</label>
        <input type="text" id="title" name="title" placeholder="Ej: Promoción" required />

        <label for="description">Descripción</label>
        <textarea id="description" name="description" placeholder="Detalle del ticket" required></textarea>

        <label for="image">Imagen (opcional)</label>
        <input type="file" id="image" name="image" accept="image/*" />

        <label for="printer">Impresora</label>
        <select id="printer" name="printer">
          <option value="">Predeterminada del sistema</option>
        </select>

        <div class="actions">
          <button type="submit" id="printBtn">Imprimir</button>
          <button type="button" id="previewBtn" style="background:#6c757d">Previsualizar</button>
        </div>
        <div class="status" id="status"></div>
      </form>

      <div class="preview" id="preview"></div>
      <div class="ticket-preview">
        <iframe id="ticketPreviewFrame" title="Previsualización del ticket" loading="lazy"></iframe>
      </div>
    </div>

    <script>
      const form = document.getElementById('ticketForm');
      const statusEl = document.getElementById('status');
      const previewEl = document.getElementById('preview');
      const imageInput = document.getElementById('image');
      const printerSelect = document.getElementById('printer');
      const printBtn = document.getElementById('printBtn');
      const previewBtn = document.getElementById('previewBtn');
      const ticketPreviewFrame = document.getElementById('ticketPreviewFrame');
      let apiBase = window.location.origin;

      imageInput.addEventListener('change', () => {
        previewEl.innerHTML = '';
        const file = imageInput.files && imageInput.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          const img = document.createElement('img');
          img.src = reader.result;
          previewEl.appendChild(img);
        };
        reader.readAsDataURL(file);
      });

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        statusEl.textContent = '';
        printBtn.disabled = true;
        try {
          const fd = new FormData(form);
          const resp = await fetch(apiBase + '/print', { method: 'POST', body: fd });
          const data = await resp.json();
          if (!resp.ok || !data.ok) {
            throw new Error(data.error || 'Error al imprimir');
          }
          statusEl.textContent = '¡Ticket enviado a impresión!';
          statusEl.style.color = '#198754';
        } catch (err) {
          statusEl.textContent = 'Falló la impresión: ' + err.message;
          statusEl.style.color = '#dc3545';
        } finally {
          printBtn.disabled = false;
        }
      });
      async function loadPrinters() {
        try {
          let resp = await fetch(apiBase + '/printers');
          let ct = resp.headers.get('content-type') || '';
          if (!ct.includes('application/json')) {
            // Fallback a Node en puerto 5450 si el origen actual devuelve HTML (p.ej. Apache)
            resp = await fetch('http://localhost:5450/printers');
            apiBase = 'http://localhost:5450';
            ct = resp.headers.get('content-type') || '';
          }
          const data = await resp.json();
          if (!resp.ok || !data.ok) throw new Error(data.error || 'No se pudieron listar impresoras');
          let { printers, defaultPrinter } = data;
          if (!Array.isArray(printers)) printers = [];
          printers.forEach(name => {
            const opt = document.createElement('option');
            opt.value = name;
            opt.textContent = name;
            printerSelect.appendChild(opt);
          });
          const defName = typeof defaultPrinter === 'string' ? defaultPrinter : (defaultPrinter && (defaultPrinter.name || defaultPrinter.PrinterName || defaultPrinter.deviceId || defaultPrinter.DeviceID));
          if (defName) {
            // Selecciona la impresora predeterminada si está en la lista
            const found = Array.from(printerSelect.options).find(o => o.value === defName);
            if (found) printerSelect.value = defName;
          }
        } catch (err) {
          statusEl.textContent = 'No se pudo cargar la lista de impresoras: ' + err.message;
          statusEl.style.color = '#dc3545';
        }
      }

      window.addEventListener('DOMContentLoaded', loadPrinters);

      previewBtn.addEventListener('click', async () => {
        statusEl.textContent = '';
        previewBtn.disabled = true;
        try {
          const fd = new FormData(form);
          const resp = await fetch(apiBase + '/preview', { method: 'POST', body: fd });
          const ct = resp.headers.get('content-type') || '';
          if (!ct.includes('application/pdf')) {
            const data = await resp.json().catch(() => ({}));
            throw new Error(data.error || 'No se pudo generar la previsualización');
          }
          const blob = await resp.blob();
          const url = URL.createObjectURL(blob);
          // Oculta la barra de herramientas y el panel lateral del visor
          ticketPreviewFrame.src = url + '#toolbar=0&navpanes=0&view=FitH&page=1';
        } catch (err) {
          statusEl.textContent = 'Falló la previsualización: ' + err.message;
          statusEl.style.color = '#dc3545';
        } finally {
          previewBtn.disabled = false;
        }
      });
    </script>
  </body>
  </html>